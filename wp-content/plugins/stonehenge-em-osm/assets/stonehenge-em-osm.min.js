jQuery.noConflict();
(function(jQuery) {
jQuery(document).ready(function(){
	// Settings Page.
	if( jQuery('#per_location_no').length > 0 ) {
		if( jQuery('#per_location_no').is(':checked') ) {
			jQuery('.per-admin').hide();
		}
		else {
			jQuery('.per-admin').show();
		}

		jQuery('[name="stonehenge_em_osm[per_location]"]').click(function() {
			jQuery('.per-admin').toggle();
		});
	}
/*
// Is marker draggable? (Runs for every map)
if( jQuery('#location-address').length > 0 ) {
setTimeout( function() {
if( jQuery('#location-address').attr('disabled') ) {
marker.dragging.disable();
} else {
marker.dragging.enable();
marker.on('dragend', function(e) {
jQuery('#location-latitude').val( marker.getLatLng().lat );
jQuery('#location-longitude').val( marker.getLatLng().lng );
});
}
}, 1800);
}
*/


// Location Select
	if( jQuery('#location-select-id').length > 0 ) {
		marker.dragging.disable();
		jQuery('#location-select-id').change( function() {
			var	LocID 		= jQuery("#location-select-id option:selected").val(),
				Coords	 	= jQuery("#location-select-id option:selected").attr('title').split(","),
				Lat 		= Coords[0],
				Lng 		= Coords[1],
				osmCustom	= jQuery("#location-select-id option:selected").attr('osm').split(","),
				iconColor	= osmCustom[0] ,
				markerUrl 	= pluginUrl + iconColor + '.png',
				mapUrl 		= osmCustom[1],
				balloon 	= jQuery("#location-select-id option:selected").attr('balloon');

				jQuery('#location-id').val( LocID );
				jQuery('#location-latitude').val( Lat );
				jQuery('#location-longitude').val( Lng );
				jQuery('#location-marker').val( iconColor );
				jQuery('#location-map').val( mapUrl );

			if( LocID === '0' ) {
				new L.tileLayer( defaultMap ).addTo(map);
				marker.setLatLng( [0,0] ).setIcon(new LeafIcon({iconUrl: defaultMarker})).bindPopup(balloon).openPopup();
				map.setView( [0,0], 1 );
			}
			else {
				new L.tileLayer( mapUrl ).addTo(map);
				marker.setLatLng( [Lat,Lng]).setIcon(new LeafIcon({iconUrl: markerUrl})).bindPopup(balloon).openPopup();
				map.setView( [Lat,Lng], zoomLevel );
			}
		}).trigger('change');
	}

// Edit Event Page.
	// Location Checkbox
	if( jQuery('#no-location').length > 0 ) {
		if( jQuery('#no-location').is(':checked') ) {
			jQuery('.location-form-where').hide();
		}
		jQuery('#no-location').click( function() {
			jQuery('.location-form-where').slideToggle(250);
			setTimeout(function(){ map.invalidateSize()}, 500);
		});
	}

	// Form Fields.
	if( jQuery('.location-form-where input#location-name').length > 0 ) {
		// Disable on Pageload?
		if( jQuery('input#location-id').val() != '0' && jQuery('input#location-id').val() != '' ) {
			jQuery('#osm-location-table input, #osm-location-table select').not(':input[type=button]').attr('disabled', true);
			jQuery('#osm-button').hide();
			jQuery('#osm-location-reset').show();
		}
		else {
			// No location set, so reset map.
			new L.tileLayer( defaultMap ).addTo(map);
			marker.setLatLng([0,0]).setIcon(new LeafIcon({iconUrl: defaultMarker})).bindPopup(' ').closePopup();
			map.setView([0,0],1);
		}

		// OnClick Reset Form.
		jQuery('#osm-location-reset a').click( function(){
			jQuery('#osm-location-table input, #osm-location-table select').not(':input[type=button]').attr('disabled', false).val('');
			jQuery('#osm-button').show(150);
			jQuery('#osm-location-reset').hide(150);

			// Reset map.
			new L.tileLayer( defaultMap ).addTo(map);
			marker.setLatLng([0,0]).setIcon(new LeafIcon({iconUrl: defaultMarker})).bindPopup(' ').closePopup();
			map.setView([0,0],1);
			return false;
		});

		// Autocomplete Ajax Search.
		jQuery('.location-form-where input#location-name').autocomplete({
			source: OSM.AutoComplete,
			delay: 500,
			minLength: 3,
			focus: function( event, ui ) {
				jQuery('input#location-id').val( ui.item.value );
				return false;
			},
			select: function( event, ui ) {
				var	LocID 		= ui.item.id,
					Lat 		= ui.item.latitude,
					Lng 		= ui.item.longitude,
					iconColor	= ui.item.marker || defaultColor,
					markerUrl 	= pluginUrl + iconColor + '.png',
					mapUrl 		= ui.item.maptype || defaultMap,
					balloon 	= '<b>'+ ui.item.value +'</b><br>'+ ui.item.address +', '+ ui.item.town;

				jQuery('#location-id').val(LocID);
				jQuery('#location-latitude').val(Lat);
				jQuery('#location-longitude').val(Lng);
				jQuery("#location-name" ).val(ui.item.value);
				jQuery('#location-address').val(ui.item.address);
				jQuery('#location-town').val(ui.item.town);
				jQuery('#location-state').val(ui.item.state);
				jQuery('#location-region').val(ui.item.region);
				jQuery('#location-postcode').val(ui.item.postcode);
				jQuery('#location-country').val(ui.item.country);
				jQuery('#location_marker_color').val(ui.item.marker);
				jQuery('#location_map_type').val(ui.item.maptype);
				jQuery('#location-icon').val(ui.item.marker);
				jQuery('#location-map').val(ui.item.maptype);
				jQuery('#osm-location-table input, #osm-location-table select').not(':input[type=button]').attr('disabled', true);
				jQuery('#osm-button').hide();
				jQuery('#osm-location-reset').show();

				// Move the Map.
				marker.setLatLng( [Lat,Lng]).setIcon(new LeafIcon({iconUrl: markerUrl})).bindPopup(balloon).openPopup();
				map.setView( [Lat,Lng], zoomLevel );
				return false;
			}
		}).data('ui-autocomplete')._renderItem = function( ul, item ) {
			html_val = "<a>" + em_esc_attr(item.label) + '<br><span style="font-size:12px"><em>'+ em_esc_attr(item.address) + ', ' + em_esc_attr(item.town)+"</em></span></a>";
			return jQuery( "<li></li>" ).data( "item.autocomplete", item ).append(html_val).appendTo( ul );
		};
	}
});
})
(jQuery);

	// OSM OpenCage API Search
	function apiSearch() {
		geoAddress( jQuery('#location-address').val() +', '+ jQuery('#location-town').val() +', '+ jQuery('#location-postcode').val() +', '+ jQuery('#location-state').val() );
	}

	function geoAddress(query) {
		jQuery.ajax({
			url: 'https://api.opencagedata.com/geocode/v1/json',
			method: 'GET',
			data: {
				'key': OPCapi,
				'q': query,
				'no_annotations': 1,
				'add_request': 1,
				'pretty': 1,
				'language': osmLocale,
			},
			dataType: 'json',
			statusCode: {
				200: function(response) {
					var result = response.results[0];
					console.log(result);
					var formatted = result.formatted;
					var components = result['components']
					if( components.city ) 		{ jQuery('#location-town').val( components.city );}
					if( components.town ) 		{ jQuery('#location-town').val( components.town );}
					if( components.village ) 	{ jQuery('#location-town').val( components.village );}
					if( components.state ) 		{ jQuery('#location-state').val( components.state );}
					if( components.county ) 	{ jQuery('#location-region').val( components.county );}
					if( components.postcode ) 	{ jQuery('#location-postcode').val( components.postcode );}
					if( components.country_code ) {
					var countryCode = components.country_code.toUpperCase();
						jQuery('#location-country').val( countryCode );
					}
					var newLat = result['geometry']['lat'];
					var newLng = result['geometry']['lng'];
					var newLatLng = new L.LatLng(newLat, newLng);
					jQuery('#location-latitude').val( newLat );
					jQuery('#location-longitude').val( newLng );

					// Move map.
					marker.setLatLng(newLatLng).bindPopup(formatted).openPopup();
					map.setView(newLatLng, zoomLevel);

					marker.dragging.enable();
					marker.on('dragend', function(e) {
						jQuery('#location-latitude').val( marker.getLatLng().lat );
						jQuery('#location-longitude').val( marker.getLatLng().lng );
					});
				},
				402: function() {
					console.log('hit free-trial daily limit');
					console.log('become a customer: https://opencagedata.com/pricing');
				}
			}
		});
	}
